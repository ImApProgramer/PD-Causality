# 0807
## PoseFormerV2
### Baseline
参数：
```
best_params = {
        "lr": 1e-05,
        "num_epochs": 20,
        "num_hidden_layers": 2,
        "layer_sizes": [256, 50, 16, 3],
        "optimizer": 'RMSprop',
        "use_weighted_loss": True,
        "batch_size": 128,
        "dropout_rate": 0.1,
        'weight_decay': 0.00057,
        'momentum': 0.66
    }
```

```
python eval_encoder.py --backbone poseformerv2 --medication 1 --train_mode end2end
```

相比于0801第一次运行的时候没有任何改动。

训练结果如下：
```
==========BEST REPORTS============
              precision    recall  f1-score   support

           0       0.45      0.57      0.50      1005
           1       0.27      0.21      0.24       828
           2       0.30      0.25      0.27       483

    accuracy                           0.37      2316
   macro avg       0.34      0.34      0.34      2316
weighted avg       0.35      0.37      0.36      2316

              precision    recall  f1-score   support

           0       0.62      0.68      0.65       654
           1       0.23      0.21      0.22       306
           2       0.29      0.26      0.27       249

    accuracy                           0.47      1209
   macro avg       0.38      0.38      0.38      1209
weighted avg       0.45      0.47      0.46      1209

              precision    recall  f1-score   support

           0       0.23      0.38      0.29       351
           1       0.30      0.21      0.25       522
           2       0.31      0.24      0.27       234

    accuracy                           0.27      1107
   macro avg       0.28      0.27      0.27      1107
weighted avg       0.28      0.27      0.26      1107

==========LAST REPORTS============
              precision    recall  f1-score   support

           0       0.54      0.52      0.53      1005
           1       0.33      0.30      0.32       828
           2       0.19      0.24      0.21       483

    accuracy                           0.38      2316
   macro avg       0.36      0.35      0.35      2316
weighted avg       0.39      0.38      0.39      2316

              precision    recall  f1-score   support

           0       0.68      0.60      0.64       654
           1       0.34      0.36      0.35       306
           2       0.24      0.29      0.26       249

    accuracy                           0.48      1209
   macro avg       0.42      0.42      0.42      1209
weighted avg       0.50      0.48      0.49      1209

              precision    recall  f1-score   support

           0       0.33      0.36      0.34       351
           1       0.33      0.27      0.29       522
           2       0.14      0.18      0.16       234

    accuracy                           0.28      1107
   macro avg       0.27      0.27      0.27      1107
weighted avg       0.29      0.28      0.28      1107


```

#### 不加入medication
```
python eval_encoder.py --backbone poseformerv2  --train_mode end2end
```

```
==========BEST REPORTS============
              precision    recall  f1-score   support

           0       0.43      0.44      0.44      1005
           1       0.29      0.32      0.30       828
           2       0.15      0.12      0.13       483

    accuracy                           0.33      2316
   macro avg       0.29      0.29      0.29      2316
weighted avg       0.32      0.33      0.33      2316

              precision    recall  f1-score   support

           0       0.61      0.54      0.58       654
           1       0.24      0.30      0.27       306
           2       0.14      0.13      0.13       249

    accuracy                           0.40      1209
   macro avg       0.33      0.33      0.32      1209
weighted avg       0.42      0.40      0.41      1209

              precision    recall  f1-score   support

           0       0.20      0.25      0.22       351
           1       0.32      0.33      0.33       522
           2       0.17      0.11      0.13       234

    accuracy                           0.25      1107
   macro avg       0.23      0.23      0.23      1107
weighted avg       0.25      0.25      0.25      1107

==========LAST REPORTS============
              precision    recall  f1-score   support

           0       0.50      0.62      0.55      1005
           1       0.36      0.29      0.32       828
           2       0.16      0.13      0.14       483

    accuracy                           0.40      2316
   macro avg       0.34      0.35      0.34      2316
weighted avg       0.38      0.40      0.38      2316

              precision    recall  f1-score   support

           0       0.57      0.65      0.61       654
           1       0.25      0.25      0.25       306
           2       0.23      0.16      0.19       249

    accuracy                           0.44      1209
   macro avg       0.35      0.35      0.35      1209
weighted avg       0.42      0.44      0.43      1209

              precision    recall  f1-score   support

           0       0.39      0.56      0.46       351
           1       0.45      0.32      0.37       522
           2       0.11      0.11      0.11       234

    accuracy                           0.35      1107
   macro avg       0.31      0.33      0.31      1107
weighted avg       0.36      0.35      0.34      1107
```

准确率变化不大，但是OFF状态下对于严重类的预测严重下滑，所以这个参数应该保留。这个分支舍弃，返回baseline。

#### 更改epoch到30
`python eval_encoder.py --backbone poseformerv2  --train_mode end2end`

```
==========BEST REPORTS============
              precision    recall  f1-score   support

           0       0.44      0.48      0.46      1005
           1       0.22      0.19      0.20       828
           2       0.18      0.20      0.19       483

    accuracy                           0.32      2316
   macro avg       0.28      0.29      0.28      2316
weighted avg       0.31      0.32      0.31      2316

              precision    recall  f1-score   support

           0       0.59      0.56      0.57       654
           1       0.05      0.05      0.05       306
           2       0.13      0.17      0.15       249

    accuracy                           0.35      1209
   macro avg       0.26      0.26      0.26      1209
weighted avg       0.36      0.35      0.35      1209

              precision    recall  f1-score   support

           0       0.25      0.34      0.29       351
           1       0.33      0.27      0.30       522
           2       0.26      0.23      0.24       234

    accuracy                           0.28      1107
   macro avg       0.28      0.28      0.28      1107
weighted avg       0.29      0.28      0.28      1107

==========LAST REPORTS============
              precision    recall  f1-score   support

           0       0.44      0.61      0.51      1005
           1       0.19      0.14      0.16       828
           2       0.28      0.18      0.22       483

    accuracy                           0.35      2316
   macro avg       0.30      0.31      0.30      2316
weighted avg       0.32      0.35      0.32      2316

              precision    recall  f1-score   support

           0       0.57      0.72      0.64       654
           1       0.13      0.09      0.11       306
           2       0.26      0.17      0.20       249

    accuracy                           0.45      1209
   macro avg       0.32      0.33      0.32      1209
weighted avg       0.39      0.45      0.41      1209

              precision    recall  f1-score   support

           0       0.25      0.43      0.32       351
           1       0.23      0.16      0.19       522
           2       0.31      0.20      0.24       234

    accuracy                           0.25      1107
   macro avg       0.26      0.26      0.25      1107
weighted avg       0.25      0.25      0.24      1107
```

基本上下降，改回epoch=20，分支回退。

#### 更改lr_head为1e-4（为baseline的十倍）

```
==========BEST REPORTS============
              precision    recall  f1-score   support

           0       0.46      0.51      0.48      1005
           1       0.30      0.26      0.28       828
           2       0.22      0.22      0.22       483

    accuracy                           0.36      2316
   macro avg       0.33      0.33      0.33      2316
weighted avg       0.35      0.36      0.36      2316

              precision    recall  f1-score   support

           0       0.61      0.57      0.59       654
           1       0.25      0.26      0.25       306
           2       0.18      0.20      0.19       249

    accuracy                           0.42      1209
   macro avg       0.35      0.34      0.34      1209
weighted avg       0.43      0.42      0.42      1209

              precision    recall  f1-score   support

           0       0.27      0.40      0.32       351
           1       0.35      0.27      0.30       522
           2       0.28      0.24      0.26       234

    accuracy                           0.30      1107
   macro avg       0.30      0.30      0.30      1107
weighted avg       0.31      0.30      0.30      1107

==========LAST REPORTS============
              precision    recall  f1-score   support

           0       0.43      0.46      0.44      1005
           1       0.23      0.21      0.22       828
           2       0.17      0.17      0.17       483

    accuracy                           0.31      2316
   macro avg       0.28      0.28      0.28      2316
weighted avg       0.30      0.31      0.31      2316

              precision    recall  f1-score   support

           0       0.53      0.51      0.52       654
           1       0.08      0.08      0.08       306
           2       0.21      0.23      0.22       249

    accuracy                           0.34      1209
   macro avg       0.27      0.27      0.27      1209
weighted avg       0.35      0.34      0.35      1209

              precision    recall  f1-score   support

           0       0.28      0.36      0.32       351
           1       0.33      0.29      0.31       522
           2       0.12      0.11      0.11       234

    accuracy                           0.27      1107
   macro avg       0.25      0.25      0.25      1107
weighted avg       0.27      0.27      0.27      1107
```

结果并没有更好，回滚baseline。



### ➕optimizer改为AdamW
```
==========BEST REPORTS============
              precision    recall  f1-score   support

           0       0.54      0.51      0.52      1005
           1       0.38      0.43      0.40       828
           2       0.27      0.24      0.25       483

    accuracy                           0.42      2316
   macro avg       0.39      0.39      0.39      2316
weighted avg       0.42      0.42      0.42      2316

              precision    recall  f1-score   support

           0       0.66      0.58      0.62       654
           1       0.34      0.43      0.38       306
           2       0.18      0.18      0.18       249

    accuracy                           0.46      1209
   macro avg       0.39      0.40      0.39      1209
weighted avg       0.48      0.46      0.47      1209

              precision    recall  f1-score   support

           0       0.35      0.38      0.37       351
           1       0.40      0.42      0.41       522
           2       0.38      0.30      0.34       234

    accuracy                           0.38      1107
   macro avg       0.38      0.37      0.37      1107
weighted avg       0.38      0.38      0.38      1107

==========LAST REPORTS============
              precision    recall  f1-score   support

           0       0.51      0.52      0.51      1005
           1       0.37      0.38      0.38       828
           2       0.22      0.20      0.21       483

    accuracy                           0.40      2316
   macro avg       0.37      0.37      0.37      2316
weighted avg       0.40      0.40      0.40      2316

              precision    recall  f1-score   support

           0       0.63      0.58      0.60       654
           1       0.24      0.29      0.26       306
           2       0.10      0.10      0.10       249

    accuracy                           0.41      1209
   macro avg       0.33      0.32      0.32      1209
weighted avg       0.42      0.41      0.41      1209

              precision    recall  f1-score   support

           0       0.33      0.40      0.36       351
           1       0.46      0.44      0.45       522
           2       0.38      0.30      0.34       234

    accuracy                           0.40      1107
   macro avg       0.39      0.38      0.38      1107
weighted avg       0.40      0.40      0.40      1107


```
模型有了不错的提升，认为值得保留，作为新的baseline。

## CTR-GCN


### Baseline

* 没做数据增强
* 用的是CE loss
* 参数如下：
  ```
  best_params = {     # ⚠️这些参数是否合理呢？
            "lr": 0.1,    #0807调参：似乎有点太大了，从原来的0.1调整到0.001
            "num_epochs": 20,
            "batch_size": 64,
            "optimizer": 'SGD',
            "weight_decay": 0.0001,
            "momentum": 0.9,
            "dropout_rate": 0.3,  # 0807调参：保持和下面一致
            "use_weighted_loss": False  # 0807调参修改为True
        }
  ```

结果：


```
==========BEST REPORTS============
              precision    recall  f1-score   support

           0       0.55      0.53      0.54      1005
           1       0.36      0.32      0.34       828
           2       0.14      0.17      0.16       483
    
    accuracy                           0.38      2316
   macro avg       0.35      0.34      0.35      2316
weighted avg       0.40      0.38      0.39      2316

              precision    recall  f1-score   support
    
           0       0.67      0.55      0.60       654
           1       0.23      0.25      0.24       306
           2       0.07      0.10      0.08       249
    
    accuracy                           0.38      1209
   macro avg       0.32      0.30      0.31      1209
weighted avg       0.43      0.38      0.40      1209

              precision    recall  f1-score   support
    
           0       0.40      0.50      0.45       351
           1       0.47      0.36      0.41       522
           2       0.23      0.26      0.24       234
    
    accuracy                           0.38      1107
   macro avg       0.37      0.37      0.36      1107
weighted avg       0.40      0.38      0.38      1107

==========LAST REPORTS============
              precision    recall  f1-score   support

           0       0.55      0.67      0.60      1005
           1       0.38      0.29      0.33       828
           2       0.22      0.19      0.21       483
    
    accuracy                           0.44      2316
   macro avg       0.38      0.39      0.38      2316
weighted avg       0.42      0.44      0.42      2316

              precision    recall  f1-score   support
    
           0       0.60      0.66      0.63       654
           1       0.25      0.19      0.21       306
           2       0.01      0.01      0.01       249
    
    accuracy                           0.41      1209
   macro avg       0.29      0.29      0.28      1209
weighted avg       0.39      0.41      0.40      1209

              precision    recall  f1-score   support
    
           0       0.47      0.70      0.56       351
           1       0.45      0.36      0.40       522
           2       0.55      0.39      0.45       234
    
    accuracy                           0.47      1107
   macro avg       0.49      0.48      0.47      1107
weighted avg       0.47      0.47      0.46      1107

```



### ➕数据增强

在数据增强中，各项一起启用，显著改善了训练过程中的过拟合，现在基本每个fold的train_accuracy都不到0.6。
如：
```
Training (fold1):   0%| | 0/20 [00:06<?, ?epoch/s, train_accuracy=40.5, train_lo[INFO] Best checkpoint saved at epoch 0 with val_f1_score=0.1319
Training (fold1):   5%| | 1/20 [00:06<02:08,  6.78s/epoch, train_accuracy=40.5, Epoch 1 completed in 5.92s
Training (fold1):  10%| | 2/20 [00:13<02:01,  6.75s/epoch, train_accuracy=46.2, Epoch 2 completed in 5.90s
Training (fold1):  10%| | 2/20 [00:20<02:01,  6.75s/epoch, train_accuracy=44.2, [INFO] Best checkpoint saved at epoch 2 with val_f1_score=0.4785
Training (fold1):  15%|▏| 3/20 [00:20<01:54,  6.76s/epoch, train_accuracy=44.2, Epoch 3 completed in 5.93s
Training (fold1):  15%|▏| 3/20 [00:27<01:54,  6.76s/epoch, train_accuracy=49.1, [INFO] Best checkpoint saved at epoch 3 with val_f1_score=0.5810
Training (fold1):  20%|▏| 4/20 [00:27<01:48,  6.79s/epoch, train_accuracy=49.1, Epoch 4 completed in 5.90s
Training (fold1):  20%|▏| 4/20 [00:33<01:48,  6.79s/epoch, train_accuracy=49, tr[INFO] Best checkpoint saved at epoch 4 with val_f1_score=0.6231
Training (fold1):  25%|▎| 5/20 [00:33<01:41,  6.79s/epoch, train_accuracy=49, trEpoch 5 completed in 5.94s
Training (fold1):  30%|▎| 6/20 [00:40<01:35,  6.80s/epoch, train_accuracy=48.8, Epoch 6 completed in 5.94s
Training (fold1):  35%|▎| 7/20 [00:47<01:28,  6.78s/epoch, train_accuracy=50.4, Epoch 7 completed in 5.92s
Training (fold1):  40%|▍| 8/20 [00:54<01:21,  6.76s/epoch, train_accuracy=48.6, Epoch 8 completed in 5.93s
Training (fold1):  45%|▍| 9/20 [01:00<01:14,  6.76s/epoch, train_accuracy=56, trEpoch 9 completed in 5.94s
Training (fold1):  50%|▌| 10/20 [01:07<01:07,  6.75s/epoch, train_accuracy=48.7,Epoch 10 completed in 5.94s
Training (fold1):  55%|▌| 11/20 [01:14<01:00,  6.75s/epoch, train_accuracy=55.7,Epoch 11 completed in 5.93s
Training (fold1):  60%|▌| 12/20 [01:21<00:53,  6.75s/epoch, train_accuracy=52.8,Epoch 12 completed in 5.92s
Training (fold1):  65%|▋| 13/20 [01:27<00:47,  6.74s/epoch, train_accuracy=56.9,Epoch 13 completed in 5.92s
Training (fold1):  70%|▋| 14/20 [01:34<00:40,  6.74s/epoch, train_accuracy=53.2,Epoch 14 completed in 5.94s
Training (fold1):  75%|▊| 15/20 [01:41<00:33,  6.74s/epoch, train_accuracy=54.3,Epoch 15 completed in 5.94s
Training (fold1):  75%|▊| 15/20 [01:48<00:33,  6.74s/epoch, train_accuracy=58.9,[INFO] Best checkpoint saved at epoch 15 with val_f1_score=0.6267
Training (fold1):  80%|▊| 16/20 [01:48<00:27,  6.87s/epoch, train_accuracy=58.9,Epoch 16 completed in 5.93s
Training (fold1):  85%|▊| 17/20 [01:55<00:20,  6.83s/epoch, train_accuracy=56.4,Epoch 17 completed in 5.94s
Training (fold1):  90%|▉| 18/20 [02:02<00:13,  6.81s/epoch, train_accuracy=57.9,Epoch 18 completed in 5.93s
Training (fold1):  95%|▉| 19/20 [02:08<00:06,  6.79s/epoch, train_accuracy=58.6,Epoch 19 completed in 5.92s
Training (fold1): 100%|█| 20/20 [02:15<00:00,  6.77s/epoch, train_accuracy=55.9,
```



#### 结果

提升依然不是很大，f1-score accuracy涨了0.03左右。

```
==========BEST REPORTS============
              precision    recall  f1-score   support

           0       0.55      0.55      0.55      1005
           1       0.36      0.31      0.33       828
           2       0.23      0.29      0.26       483

    accuracy                           0.41      2316
   macro avg       0.38      0.38      0.38      2316
weighted avg       0.42      0.41      0.41      2316

              precision    recall  f1-score   support

           0       0.55      0.62      0.58       654
           1       0.30      0.23      0.26       306
           2       0.16      0.16      0.16       249

    accuracy                           0.43      1209
   macro avg       0.34      0.34      0.34      1209
weighted avg       0.41      0.43      0.41      1209

              precision    recall  f1-score   support

           0       0.54      0.41      0.47       351
           1       0.39      0.36      0.37       522
           2       0.28      0.44      0.34       234

    accuracy                           0.39      1107
   macro avg       0.40      0.40      0.39      1107
weighted avg       0.42      0.39      0.40      1107

==========LAST REPORTS============
              precision    recall  f1-score   support

           0       0.48      0.43      0.45      1005
           1       0.35      0.48      0.40       828
           2       0.37      0.21      0.27       483

    accuracy                           0.40      2316
   macro avg       0.40      0.37      0.38      2316
weighted avg       0.41      0.40      0.40      2316

              precision    recall  f1-score   support

           0       0.53      0.56      0.54       654
           1       0.24      0.30      0.27       306
           2       0.52      0.25      0.34       249

    accuracy                           0.43      1209
   macro avg       0.43      0.37      0.38      1209
weighted avg       0.45      0.43      0.43      1209

              precision    recall  f1-score   support

           0       0.31      0.19      0.24       351
           1       0.41      0.58      0.48       522
           2       0.26      0.17      0.20       234

    accuracy                           0.37      1107
   macro avg       0.33      0.31      0.31      1107
weighted avg       0.35      0.37      0.34      1107
```



### ➕使用Weighted Loss

这一步其实也是必须做的。



#### 结果

差不多涨了0.03。

```
==========BEST REPORTS============
              precision    recall  f1-score   support

           0       0.51      0.68      0.58      1005
           1       0.37      0.18      0.24       828
           2       0.32      0.37      0.34       483

    accuracy                           0.44      2316
   macro avg       0.40      0.41      0.39      2316
weighted avg       0.42      0.44      0.41      2316

              precision    recall  f1-score   support

           0       0.54      0.69      0.60       654
           1       0.00      0.00      0.00       306
           2       0.20      0.17      0.18       249

    accuracy                           0.41      1209
   macro avg       0.24      0.29      0.26      1209
weighted avg       0.33      0.41      0.36      1209

              precision    recall  f1-score   support

           0       0.47      0.68      0.55       351
           1       0.60      0.29      0.39       522
           2       0.39      0.59      0.47       234

    accuracy                           0.47      1107
   macro avg       0.49      0.52      0.47      1107
weighted avg       0.52      0.47      0.46      1107

==========LAST REPORTS============
              precision    recall  f1-score   support

           0       0.60      0.53      0.56      1005
           1       0.36      0.43      0.39       828
           2       0.31      0.28      0.29       483

    accuracy                           0.44      2316
   macro avg       0.42      0.41      0.42      2316
weighted avg       0.45      0.44      0.44      2316

              precision    recall  f1-score   support

           0       0.60      0.60      0.60       654
           1       0.10      0.12      0.11       306
           2       0.23      0.18      0.20       249

    accuracy                           0.39      1209
   macro avg       0.31      0.30      0.30      1209
weighted avg       0.40      0.39      0.39      1209

              precision    recall  f1-score   support

           0       0.61      0.39      0.48       351
           1       0.50      0.61      0.55       522
           2       0.38      0.38      0.38       234

    accuracy                           0.50      1107
   macro avg       0.50      0.46      0.47      1107
weighted avg       0.51      0.50      0.49      1107
```





### ➕参数调整，全部套用默认的+128 batch size

```
        best_params = {     # ⚠️这些参数是否合理呢？
            "lr": 1e-05,    #原本0.1
            "num_epochs": 20,
            "batch_size": 128,	#原本64
            "optimizer": 'AdamW',	#原本SGD
            "weight_decay": 0.00057,	#原本0.0001
            "momentum": 0.66,			#原本0.9
            "dropout_rate": 0.1,  		#原本0.3
            "use_weighted_loss": True  # 0807调参修改为True
        }
```

直接豁出去了。

结果过拟合似乎再次出现：

```
Training (fold0):  75%|▊| 15/20 [01:38<00:32,  6.50s/epoch, train_accuracy=86, tEpoch 15 completed in 5.50s
Training (fold0):  80%|▊| 16/20 [01:45<00:25,  6.47s/epoch, train_accuracy=87.5,Epoch 16 completed in 5.50s
Training (fold0):  85%|▊| 17/20 [01:51<00:19,  6.46s/epoch, train_accuracy=87.7,Epoch 17 completed in 5.48s
Training (fold0):  85%|▊| 17/20 [01:58<00:19,  6.46s/epoch, train_accuracy=88.9,[INFO] Best checkpoint saved at epoch 17 with val_f1_score=0.4461
Training (fold0):  90%|▉| 18/20 [01:58<00:12,  6.48s/epoch, train_accuracy=88.9,Epoch 18 completed in 5.50s
Training (fold0):  95%|▉| 19/20 [02:04<00:06,  6.47s/epoch, train_accuracy=87.9,Epoch 19 completed in 5.49s
Training (fold0):  95%|▉| 19/20 [02:11<00:06,  6.47s/epoch, train_accuracy=89.8,[INFO] Best checkpoint saved at epoch 19 with val_f1_score=0.4528
Training (fold0): 100%|█| 20/20 [02:11<00:00,  6.57s/epoch, train_accuracy=89.8,
```



训练结果尚可！

```
==========BEST REPORTS============
              precision    recall  f1-score   support

           0       0.62      0.70      0.66      1005
           1       0.42      0.47      0.44       828
           2       0.22      0.11      0.15       483

    accuracy                           0.50      2316
   macro avg       0.42      0.43      0.42      2316
weighted avg       0.46      0.50      0.48      2316

              precision    recall  f1-score   support

           0       0.68      0.70      0.69       654
           1       0.39      0.57      0.46       306
           2       0.10      0.04      0.06       249

    accuracy                           0.53      1209
   macro avg       0.39      0.43      0.40      1209
weighted avg       0.49      0.53      0.50      1209

              precision    recall  f1-score   support

           0       0.52      0.70      0.60       351
           1       0.44      0.42      0.43       522
           2       0.31      0.19      0.24       234

    accuracy                           0.46      1107
   macro avg       0.42      0.44      0.42      1107
weighted avg       0.44      0.46      0.44      1107

==========LAST REPORTS============
              precision    recall  f1-score   support

           0       0.65      0.78      0.71      1005
           1       0.55      0.57      0.56       828
           2       0.40      0.22      0.29       483

    accuracy                           0.59      2316
   macro avg       0.53      0.52      0.52      2316
weighted avg       0.56      0.59      0.57      2316

              precision    recall  f1-score   support

           0       0.69      0.74      0.71       654
           1       0.48      0.56      0.52       306
           2       0.34      0.20      0.26       249

    accuracy                           0.58      1209
   macro avg       0.50      0.50      0.50      1209
weighted avg       0.56      0.58      0.57      1209

              precision    recall  f1-score   support

           0       0.60      0.84      0.70       351
           1       0.60      0.57      0.58       522
           2       0.48      0.24      0.32       234

    accuracy                           0.59      1107
   macro avg       0.56      0.55      0.53      1107
weighted avg       0.57      0.59      0.56      1107
```



接下来可以考虑改一下optimizer到原本的那个，但是在那之前可以再跑一波，确认不是震荡。

